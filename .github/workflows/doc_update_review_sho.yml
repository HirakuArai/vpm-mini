name: Doc Update Review (Sho v2)

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: "Project ID (e.g. vpm-mini)"
        required: true
        default: "vpm-mini"
      proposal_path:
        description: "Path to doc_update_proposal_v1 JSON in the repo"
        required: true
        default: "reports/doc_update_proposals/2025-11-24-vpm-mini.json"

jobs:
  review_doc_update_proposal:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate proposal JSON exists
        run: |
          PROPOSAL_PATH="${{ github.event.inputs.proposal_path }}"
          if [ ! -f "${PROPOSAL_PATH}" ]; then
            echo "Proposal JSON not found: ${PROPOSAL_PATH}" >&2
            exit 1
          fi
          echo "[Sho v2] Found proposal JSON: ${PROPOSAL_PATH}"

      - name: Generate doc_update_review_v1 (placeholder)
        id: generate_review
        run: |
          set -euo pipefail
          PROPOSAL_PATH="${{ github.event.inputs.proposal_path }}"
          PROJECT_ID="${{ github.event.inputs.project_id }}"

          python - << 'PY'
          import datetime
          import json
          import os
          import pathlib
          import sys

          proposal_path = pathlib.Path(os.environ["PROPOSAL_PATH"])
          project_id = os.environ["PROJECT_ID"]
          if not proposal_path.exists():
            print(f"Proposal JSON not found: {proposal_path}", file=sys.stderr)
            sys.exit(1)

          proposal = json.loads(proposal_path.read_text(encoding="utf-8"))
          updates = proposal.get("updates", [])

          judgments = []
          for upd in updates:
            target = upd.get("target", {})
            target_path = target.get("path") or upd.get("target_path", "")
            section_hint = target.get("section_hint") or upd.get("section_hint", "")
            judgments.append({
              "target_path": target_path,
              "section_hint": section_hint,
              "decision": "accept",
              "risk": "low",
              "reason": "auto-accept v1; human review still recommended.",
            })

          now = datetime.datetime.now(datetime.timezone.utc).isoformat()
          review = {
            "schema_version": "doc_update_review_v1",
            "project_id": project_id,
            "proposal_ref": str(proposal_path),
            "generated_at": now,
            "overall_assessment": {
              "summary": "auto-accept v1 by Sho (blackboard)",
              "risk_level": "low",
            },
            "update_judgements": judgments,
            "notes": [
              "Auto-generated Sho v2 review: accepts all updates; please double-check manually."
            ],
          }

          out = pathlib.Path("doc_update_review_v1.json")
          out.write_text(json.dumps(review, ensure_ascii=False, indent=2), encoding="utf-8")
          print(f"Wrote {out}")
          PY

      - name: Upload review JSON as artifact
        uses: actions/upload-artifact@v4
        with:
          name: doc_update_review_v1_${{ github.event.inputs.project_id }}
          path: doc_update_review_v1.json
