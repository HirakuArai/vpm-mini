name: chatops
on:
  issue_comment:
    types: [created, edited]
permissions:
  contents: write
  pull-requests: write
  issues: write
jobs:
  handle_ask:
    if: contains(github.event.comment.body, '/ask')
    runs-on: ubuntu-latest
    steps:
      - name: Reply JSON (minimal)
        uses: actions/github-script@v7
        with:
          script: |
            const body = `{"understanding":"received '/ask'","plan":{"commands":[]},"acceptance":"ok"}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body
            });

      - name: Persist JSON via PR
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const ts = now.toISOString().replace(/[:.]/g,'').slice(0,15);
            const path = `reports/ask/ask_${ts}.json`;
            const branch = `ask/persist-${ts}`;

            // 1) base SHA
            const { data: ref } = await github.rest.git.getRef({
              owner: context.repo.owner, repo: context.repo.repo, ref: 'heads/main'
            });

            // 2) create branch
            await github.rest.git.createRef({
              owner: context.repo.owner, repo: context.repo.repo,
              ref: `refs/heads/${branch}`, sha: ref.object.sha
            });

            // 3) file content（さきほど返信した最小JSONと同じ形）
            const contentObj = {
              understanding: "received '/ask'",
              plan: { commands: [] },
              acceptance: "ok",
              meta: {
                issue: context.payload.issue.number,
                comment_id: context.payload.comment.id,
                asked_by: context.actor,
                created_at: now.toISOString()
              }
            };
            const content = Buffer.from(JSON.stringify(contentObj, null, 2)).toString('base64');

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner, repo: context.repo.repo, path,
              message: `ask: persist u_contract (${path})`,
              content, branch
            });

            // 4) PR
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner, repo: context.repo.repo,
              head: branch, base: 'main',
              title: `ask: persist u_contract (${path})`,
              body: 'Auto-generated minimal U-Contract (chatops-min)'
            });
            core.setOutput('pr', pr.data.number);
