name: Info Network Build (Aya)

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: "Project ID (e.g. vpm-mini)"
        required: true
        default: "vpm-mini"
      board_issue:
        description: "Blackboard issue number (doc_update_blackboard_v1)"
        required: true
        default: "841"

jobs:
  build_info_network:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ github.event.inputs.project_id }}
      BOARD_ISSUE_NUMBER: ${{ github.event.inputs.board_issue }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Find Aya info_network request from blackboard
        id: find
        uses: actions/github-script@v7
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          BOARD_ISSUE_NUMBER: ${{ env.BOARD_ISSUE_NUMBER }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.BOARD_ISSUE_NUMBER, 10);
            const projectId = process.env.PROJECT_ID;

            if (!issueNumber) {
              core.setFailed("BOARD_ISSUE_NUMBER is not set or invalid.");
              return;
            }

            core.info(`Searching blackboard issue #${issueNumber} for info_network_build_request_v1 to Aya (project_id=${projectId})...`);

            const comments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100,
              },
            );

            const candidates = [];
            for (const comment of comments) {
              const body = comment.body || "";
              if (!body.includes("<!-- blackboard:doc_update_v1 -->")) continue;

              const fenceMatch = body.match(/```json\s*([\s\S]*?)```/m);
              const inlineMatch = body.match(/json\s+({[\s\S]*})/m);
              const jsonText = fenceMatch?.[1] ?? inlineMatch?.[1];
              if (!jsonText) continue;

              let entry;
              try {
                entry = JSON.parse(jsonText);
              } catch (error) {
                core.info(`Skipping comment ${comment.id}: failed to parse JSON (${error}).`);
                continue;
              }

              if (
                entry?.to === "Aya" &&
                entry?.kind === "info_network_build_request_v1" &&
                entry?.status === "open" &&
                entry?.project_id === projectId
              ) {
                const createdAt =
                  entry.created_at ||
                  comment.created_at ||
                  comment.createdAt ||
                  comment.updated_at;
                const ts = Date.parse(createdAt) || 0;
                candidates.push({ entry, ts, comment });
              }
            }

            if (!candidates.length) {
              core.setFailed("No open info_network_build_request_v1 to Aya found on the blackboard.");
              return;
            }

            candidates.sort((a, b) => a.ts - b.ts);
            const oldest = candidates[0];

            core.info(`Selected Aya info_network entry with id: ${oldest.entry.id || "unknown"}`);

            core.setOutput("entry", JSON.stringify(oldest.entry));
            core.setOutput("issue_number", String(issueNumber));

      - name: Call OpenAI for info_network build (segmenter only)
        id: call
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          ENTRY_JSON: ${{ steps.find.outputs.entry }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");

            const entry = JSON.parse(process.env.ENTRY_JSON || "{}");
            const projectId = process.env.PROJECT_ID || "vpm-mini";
            const scope = entry.payload?.scope || "";

            const spec = fs.readFileSync("docs/pm/info_network_overview_v1.md", "utf8");
            const ayaSpec = fs.readFileSync("docs/pm/info_network_aya_builder_v1.md", "utf8");
            const entryText = JSON.stringify(entry, null, 2);

            const systemPrompt = [
              "あなたは Aya: info_network_builder_v1 (segmenter mode) として動作します。",
              "",
              "前提:",
              "- docs/pm/info_network_overview_v1.md で定義された info_node / info_relation v1 のルールに従ってください。",
              "- docs/pm/info_network_aya_builder_v1.md で定義された Aya の責務と入出力仕様に従ってください。",
              `- project_id は常に \"${projectId}\" とします (v1 の前提)。`,
              "- scope は blackboard entry の payload.scope に従います。",
              "",
              "重要な制約:",
              "- source_texts に明示的に書かれていない事実・制約・前提・意思決定・目的を、新しく作らないでください。",
              "- constraint / assumption / decision のノードは、対応する種類の文が source_texts に存在する場合にのみ生成してください。",
              "- CPU/メモリ/コスト制約やロールバック方針など、「一般的にありそうな内容」を勝手に追加してはいけません。",
              "- max_nodes は最大値であり、事実が少なければノード数が少ないままで構いません。",
              "",
              "タスク:",
              "- blackboard entry (info_network_build_request_v1) に含まれる scope / notes / source_texts を読み、",
              "  scope に対応する info_node と info_relation の案を作成してください。",
              "- 1ノード = 1 subject × 1 kind × 1文 のルールを守ってください。",
              "- kind は purpose / expected_state / actual_state / constraint / assumption / decision のいずれかを使ってください。",
              "- relation type は refines / supports / blocks / depends_on のいずれかを使ってください。",
              "- 出力は YAML のみとし、以下のトップレベル構造で返してください:",
              `  project_id: \"${projectId}\"`,
              `  scope: \"${scope}\"`,
              "  nodes: [...]",
              "  relations: [...]",
              "",
              "YAML 以外の説明文やコードフェンスは含めないでください。"
            ].join("\n");

            const userPrompt = [
              "### info_network_overview_v1 + Aya segmenter role spec",
              "",
              spec,
              "",
              ayaSpec,
              "",
              "### blackboard entry (info_network_build_request_v1)",
              "",
              entryText,
              "",
              "上記を踏まえて、指定された scope についての info_node / info_relation を YAML で生成してください。"
            ].join("\n");

            const res = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`
              },
              body: JSON.stringify({
                model: "gpt-4.1-mini",
                temperature: 0,
                messages: [
                  { role: "system", content: systemPrompt },
                  { role: "user", content: userPrompt }
                ]
              })
            });

            if (!res.ok) {
              const err = await res.text();
              core.setFailed(`OpenAI API error: ${res.status} ${res.statusText}: ${err}`);
              return;
            }

            const data = await res.json();
            const contentText = data.choices?.[0]?.message?.content;
            if (!contentText) {
              core.setFailed("No content returned from OpenAI.");
              return;
            }

            fs.writeFileSync("info_network_aya.yml", contentText, "utf8");
            core.setOutput("yaml", contentText);

      - name: Upload info_network YAML artifact
        uses: actions/upload-artifact@v4
        with:
          name: info_network_aya_${{ github.run_number }}
          path: info_network_aya.yml

      - name: Post Aya info_network proposal as comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE="${{ steps.find.outputs.issue_number }}"
          {
            echo 'Aya info_network (segmenter) YAML:'
            echo
            echo '```yaml'
            cat info_network_aya.yml
            echo '```'
          } > .tmp_comment.txt

          gh issue comment "$ISSUE" -F .tmp_comment.txt

      - name: Mark Aya request as done on blackboard
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENTRY_JSON: ${{ steps.find.outputs.entry }}
          ISSUE_NUMBER: ${{ steps.find.outputs.issue_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const entry = JSON.parse(process.env.ENTRY_JSON || "{}");
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);

            entry.status = "done";
            entry.updated_at = new Date().toISOString();

            const bodyLines = [
              "<!-- blackboard:doc_update_v1 -->",
              "",
              "json",
              JSON.stringify(entry, null, 2)
            ];
            const body = bodyLines.join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body
            });
