name: code_checks_enforcer (non-evidence PRs must run heavy checks)
on:
  pull_request_target:
    types: [opened, synchronize, labeled, reopened]
permissions:
  contents: read
  checks: read
  statuses: read

jobs:
  enforce:
    runs-on: ubuntu-latest
    steps:
      - name: Decide evidence-only via API
        id: decide
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const headRef = (pr && pr.head && pr.head.ref) || '';
            const labels = (pr && pr.labels ? pr.labels.map(l=>l.name) : []);
            const files = await github.paginate(github.pulls.listFiles, { owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number, per_page: 100 });
            const paths = files.map(f=>f.filename);
            const onlyEvidence = paths.length > 0 && paths.every(p => p.startsWith('reports/ask/') || p.startsWith('codex/inbox/'))
            const isEvidence = headRef.startsWith('ask/store/') || labels.includes('evidence') || onlyEvidence;
            const isCIOnly = paths.length > 0 && paths.every(p => p.startsWith('.github/'));
            const isCILabel = labels.includes('ci') || labels.includes('runner');
            core.info(`enforcer decide: isEvidence=${isEvidence} isCIOnly=${isCIOnly} isCILabel=${isCILabel} headRef=${headRef} labels=${labels.join(',')} paths=${paths.length}`);
            core.setOutput('is_evidence', isEvidence ? 'true' : 'false');
            core.setOutput('is_cionly', isCIOnly ? 'true' : 'false');
            core.setOutput('is_cilabel', isCILabel ? 'true' : 'false');
      - name: Skip on evidence-only or CI-only or CI-labeled
        if: steps.decide.outputs.is_evidence == 'true' || steps.decide.outputs.is_cionly == 'true' || steps.decide.outputs.is_cilabel == 'true'
        run: echo "enforcer skipped (evidence or ci-only/label)"
      - name: Enforce heavy checks for code PRs
        if: steps.decide.outputs.is_evidence != 'true' && steps.decide.outputs.is_cionly != 'true' && steps.decide.outputs.is_cilabel != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const ref = pr.head.sha;
            const required = ['test-and-artifacts', 'knative-ready', 'k8s-validate'];
            const { data: status } = await github.repos.getCombinedStatusForRef({ owner: context.repo.owner, repo: context.repo.repo, ref });
            const contexts = new Map(status.statuses.map(s => [s.context, s.state]));
            const checks = await github.checks.listForRef({ owner: context.repo.owner, repo: context.repo.repo, ref, per_page: 100 });
            for (const c of checks.data.check_runs) { contexts.set(c.name, c.conclusion || c.status); }
            const missing = [];
            for (const r of required) {
              const v = contexts.get(r);
              if (!v || !(v === 'success' || v === 'completed' || v === 'neutral')) missing.push(r);
            }
            if (missing.length) { core.setFailed(`Missing or failing heavy checks for code PR: ${missing.join(', ')}`); }
            else { console.log('All required heavy checks present.'); }
