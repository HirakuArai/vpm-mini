name: Auto-approve Evidence PRs (bot)
on:
  pull_request_target:
    types: [labeled, synchronize, opened]
permissions:
  pull-requests: write
  contents: read

jobs:
  approve-if-evidence-only:
    runs-on: ubuntu-latest
    steps:
      - name: Decide via API
        id: decide
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const headRef = (pr && pr.head && pr.head.ref) || '';
            const labels = (pr && pr.labels ? pr.labels.map(l=>l.name) : []);
            const files = await github.paginate(github.pulls.listFiles, { owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number, per_page: 100 });
            const paths = files.map(f=>f.filename);
            core.info(`headRef=${headRef}`);
            core.info(`labels=${labels.join(',')}`);
            core.info(`changed=${paths.length} -> ${paths.join('|')}`);
            const onlyEvidence = paths.length > 0 && paths.every(p => p.startsWith('reports/ask/') || p.startsWith('codex/inbox/'))
            const ok = headRef.startsWith('ask/store/') && labels.includes('evidence') && onlyEvidence;
            core.setOutput('ok', ok ? 'true' : 'false');

      - name: Approve via BOT PAT
        if: steps.decide.outputs.ok == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.EVIDENCE_APPROVER_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            await github.pulls.createReview({ owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number, event: 'APPROVE', body: 'Auto-approving evidence-only PR (bot).' });
