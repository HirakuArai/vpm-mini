name: Auto-approve Evidence PRs (v2.2)
on:
  pull_request_target:
    types: [labeled, synchronize, opened]
permissions:
  pull-requests: write
  contents: read

jobs:
  approve-if-evidence-only:
    runs-on: ubuntu-latest
    steps:
      - name: Compute head ref
        id: vars
        shell: bash
        run: echo "head_ref=${{ github.event.pull_request.head.ref || github.head_ref || '' }}" >> $GITHUB_OUTPUT

      - name: Fetch changed files (base vs head)
        id: files
        uses: tj-actions/changed-files@v44
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          since_last_remote_commit: false

      - name: Decide evidence-only
        id: decide
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const headRef = '${{ steps.vars.outputs.head_ref }}';
            const labels = pr.labels.map(l=>l.name);
            const changed = (process.env.CHANGED || '').split('
').filter(Boolean);
            core.info(`headRef=${headRef}`);
            core.info(`labels=${labels.join(',')}`);
            core.info(`changed-count=${changed.length}`);
            const onlyEvidence = changed.length > 0 && changed.every(p => p.startsWith('reports/ask/') || p.startsWith('codex/inbox/'));
            const ok = headRef.startsWith('ask/store/') && labels.includes('evidence') && onlyEvidence;
            core.setOutput('ok', ok ? 'true':'false');
          env:
            CHANGED: ${{ steps.files.outputs.all_changed_files }}

      - name: Approve via API
        if: steps.decide.outputs.ok == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            await github.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              event: 'APPROVE',
              body: 'Auto-approving evidence-only PR (v2.2).'
            });
