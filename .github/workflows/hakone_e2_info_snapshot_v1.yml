name: Hakone-e2 Info Snapshot v1

on:
  workflow_dispatch: {}

jobs:
  build_info_snapshot:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read hakone-e2 current_state
        id: read_state
        run: |
          CONTENT=$(cat STATE/hakone-e2/current_state.md)
          CONTENT="${CONTENT//'%'/'%25'}"
          CONTENT="${CONTENT//$'\n'/'%0A'}"
          CONTENT="${CONTENT//$'\r'/'%0D'}"
          echo "content=$CONTENT" >> $GITHUB_OUTPUT

      - name: Generate hakone-e2 info snapshot (Kai+Aya)
        id: generate_snapshot
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # OPENAI_BASE_URL is optional; script defaults to https://api.openai.com/v1
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
        run: |
          python tools/info_network/generate_info_snapshot_v1.py \
            --current-state STATE/hakone-e2/current_state.md \
            --schema-doc docs/pm/info_network_v1_schema.md \
            --job-doc docs/projects/hakone-e2/info_network_job_v1.md \
            --model gpt-4.1 \
            --output reports/hakone-e2/info_snapshot_v1_raw.json

      - name: Apply info snapshot to data/hakone-e2
        id: apply_snapshot
        run: |
          python tools/info_network/apply_info_snapshot_v1.py \
            --input reports/hakone-e2/info_snapshot_v1_raw.json \
            --nodes data/hakone-e2/info_nodes_v1.json \
            --relations data/hakone-e2/info_relations_v1.json
          echo "Applied snapshot to data/hakone-e2/info_nodes_v1.json and info_relations_v1.json"

      - name: Upload snapshot JSON artifact
        uses: actions/upload-artifact@v4
        with:
          name: hakone-e2-info-snapshot-v1
          path: reports/hakone-e2/info_snapshot_v1_raw.json
