name: ask-entry

on:
  repository_dispatch:
  workflow_dispatch:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

# 保存PRやコメントを書けるように最初に明示
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

concurrency:
  group: ask-${{ github.ref }}
  cancel-in-progress: false

jobs:
  ask:
    # 起動条件：issue_comment か workflow/rep dispatch、
    # もしくは issues.opened かつ labels に "ask" が含まれるとき
    if: >
      github.event_name == 'issue_comment' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'repository_dispatch' ||
      (github.event_name == 'issues' && contains(toJson(github.event.issue.labels), '"name":"ask"'))
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build prompt
        run: |
          set -euo pipefail
          mkdir -p out reports/ask
          ISSUE_BODY="${{ github.event_name == 'issue_comment' && github.event.comment.body || github.event.issue.body }}"
          printf '%s\n' "$(cat tools/prompts/llm_relay_system.md)" > out/sys.txt
          printf 'context_header: repo=vpm-mini / branch=main / phase=Phase 2\n' > out/ctx.txt
          printf 'QUESTION\n%s\n' "$(echo "$ISSUE_BODY")" >> out/ctx.txt

      - name: Call OpenAI (gpt-5; raw & strip fences)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          jq -n --arg sys "$(cat out/sys.txt)" --arg usr "$(cat out/ctx.txt)" '{
            model:"gpt-5",
            response_format:{type:"json_object"},
            messages:[{role:"system",content:$sys},{role:"user",content:$usr}]
          }' > out/req.json

          curl -sS https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @out/req.json \
            | tee out/raw.json >/dev/null || true

          jq -r '.choices[0].message.content // ""' out/raw.json > out/u_contract.txt

          if [ ! -s out/u_contract.txt ]; then
            # フォールバック（最小スキーマ）
            CH="$(sed -n '1s/^context_header: //p' out/ctx.txt)"
            jq -n --arg ch "$CH" '{
              typing:"no-content",
              context_header:$ch,
              understanding:{C:"",G:"",delta:"",assumptions:[],unknowns:[]},
              plan:[],acceptance:[],citations:[],confidence:0.0
            }' > out/u_contract.json
          else
            # ```json … ``` のフェンス除去
            awk 'NR==1{sub(/^```(json)?[[:space:]]*/,"")} {buf=buf $0 ORS} END{ sub(/```[[:space:]]*[\r\n]*$/,"",buf); printf "%s", buf }' \
              out/u_contract.txt > out/u_contract.json
          fi

      - name: Normalize + Coerce (minimal schema)
        run: |
          set -euo pipefail
          CH=$(sed -n '1s/^context_header: //p' out/ctx.txt)
          jq --arg ch "$CH" '
            (.context_header //= $ch)
            | (.typing //= "plan要約")
            | (.confidence //= 0.5)
            | (.understanding |=
                ( if type=="string" then
                    {C:., G:"", delta:"", assumptions:[], unknowns:[]}
                  elif type=="null" then
                    {C:"", G:"", delta:"", assumptions:[], unknowns:[]}
                  elif type=="object" then
                    (.C //= "") | (.G //= "") | (.delta //= "")
                    | (.assumptions //= []) | (.unknowns //= [])
                  else
                    {C:"", G:"", delta:"", assumptions:[], unknowns:[]}
                  end ))
            | (.plan |= ( if type=="string" then
                            [ {id:"p1", desc:., commands:[], evidence:[], risks:[]} ]
                          elif type=="array" then
                            [ range(0; length) as $i | .[$i]
                              | ( if type=="string"
                                    then {id:("p"+(($i+1)|tostring)), desc:., commands:[], evidence:[], risks:[]}
                                    elif type=="object" then . else . end ) ]
                          else [] end ))
            | (.acceptance |= ( if type=="string" then [.] elif type=="array" then . else [] end ))
            | (.citations |= ( if type=="string" then [ {path:., lines:""} ]
                               elif type=="array" then [ .[] | ( if type=="string" then {path:., lines:""} else . end ) ]
                               elif type=="object" then [.] else [] end ))
          ' out/u_contract.json > out/u_contract.norm.json
          mv out/u_contract.norm.json out/u_contract.json

      - name: Comment back JSON (issue/pr only)
        if: ${{ github.event_name == 'issue_comment' || github.event_name == 'issues' || github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
        run: |
          set -euo pipefail
          BODY="$(printf '%s\n%s\n%s\n' '```json' "$(cat out/u_contract.json)" '```')"
          gh api "repos/${REPO}/issues/${ISSUE_NUMBER}/comments" -f body="$BODY"

      - name: Open Save-PR (always)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ts=$(date -u +%Y%m%dT%H%M%SZ)
          mkdir -p reports/ask
          cp out/u_contract.json "reports/ask/ask_${ts}.json"

          git config user.email "bot@users.noreply.github.com"
          git config user.name  "github-actions[bot]"

          BR="ask/store/${ts}"
          git checkout -b "$BR"
          git add "reports/ask/ask_${ts}.json"
          git commit -m "ask: persist u_contract (${ts})"
          git push -u origin "$BR"

          gh pr create --base main --head "$BR" \
            -t "ask: persist u_contract (${ts})" \
            -b "Persisted from ask-entry." \
            --label ask --label evidence || true

  ask_pr_direct:
    name: Ask PR-direct (commit codex/inbox/ask_<ts>.json)
    if: >
      github.event.issue.pull_request != null &&
      startsWith(github.event.comment.body, '/ask')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Fetch PR head ref
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('head_ref', pr.head.ref);

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_ref }}

      - name: Ensure codex/inbox directory
        run: |
          set -euo pipefail
          mkdir -p codex/inbox

      - name: Initialize S5 env defaults
        run: |
          set -euo pipefail
          echo "S5_ACTIVE=0" >> "$GITHUB_ENV"

      - name: Generate ask/apply inbox JSON
        id: gen
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          TS=$(date -u +%Y%m%dT%H%M%SZ)
          DEFAULT_MANIFEST="infra/k8s/overlays/dev/hello-ksvc.yaml"
          HAS_S5_MARKER=0
          MANIFEST=""
          if printf '%s' "$COMMENT_BODY" | grep -iq 'S5 apply: dev'; then
            HAS_S5_MARKER=1
            S5_LINE=$(printf '%s\n' "$COMMENT_BODY" | grep -i 'S5 apply: dev' | head -n1 || true)
            if [ -n "${S5_LINE:-}" ]; then
              MANIFEST=$(printf '%s\n' "$S5_LINE" | awk '{print $4}')
            fi
          fi
          if [ -z "$MANIFEST" ] || [ "$MANIFEST" = "hello-ksvc" ]; then
            MANIFEST="$DEFAULT_MANIFEST"
          fi

          IS_DEV_MANIFEST=0
          if printf '%s' "$MANIFEST" | grep -q '^infra/k8s/overlays/dev/'; then
            IS_DEV_MANIFEST=1
          fi

          if [ "$HAS_S5_MARKER" -eq 1 ] && [ "$IS_DEV_MANIFEST" -eq 1 ]; then
            ID="s5_apply_${TS}.json"
            FILE="codex/inbox/${ID}"
            jq -n --arg pr "$PR_NUMBER" --arg manifest "$MANIFEST" '{
              kind: "apply",
              source: "pr-direct-s5",
              approved: true,
              approver: "HirakuArai",
              scope: $manifest,
              pr_number: ($pr|tonumber),
              note: ("S5 dev apply: " + $manifest),
              actions: [
                {
                  type: "k8s-apply",
                  path: $manifest,
                  resource: {
                    kind: "Service",
                    name: "hello",
                    namespace: "default"
                  }
                }
              ]
            }' > "${FILE}"
            echo "S5_ACTIVE=1" >> "$GITHUB_ENV"
            echo "S5_JSON_PATH=${FILE}" >> "$GITHUB_ENV"
            echo "S5_MANIFEST=${MANIFEST}" >> "$GITHUB_ENV"
            echo "S5_PR=${PR_NUMBER}" >> "$GITHUB_ENV"
            echo "S5_EVIDENCE_BRANCH=ask/store/s5-apply-${PR_NUMBER}-${GITHUB_RUN_ID}" >> "$GITHUB_ENV"
          else
            ID="ask_${TS}.json"
            FILE="codex/inbox/${ID}"
            printf '{"kind":"ask","source":"pr-direct","note":"T2 E2E smoke from PR comment #%s"}\n' "$PR_NUMBER" > "${FILE}"
          fi

          echo "ASK_FILE=${FILE}" >> "$GITHUB_ENV"

      - name: Checkout base for S5 evidence PR
        if: env.S5_ACTIVE == '1'
        uses: actions/checkout@v4
        with:
          path: s5-evidence
          ref: main

      - name: Stage S5 JSON for evidence PR
        if: env.S5_ACTIVE == '1'
        run: |
          set -euo pipefail
          mkdir -p "s5-evidence/$(dirname "$S5_JSON_PATH")"
          cp "$S5_JSON_PATH" "s5-evidence/$S5_JSON_PATH"
        env:
          S5_JSON_PATH: ${{ env.S5_JSON_PATH }}

      - name: Create S5 apply evidence PR
        if: env.S5_ACTIVE == '1'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: s5-evidence
          branch: ${{ env.S5_EVIDENCE_BRANCH }}
          base: main
          title: "Evidence: S5 apply inbox for #${{ env.S5_PR }}"
          body: |
            S5 apply inbox JSON for /ask on #${{ env.S5_PR }}.

            - scope: ${{ env.S5_MANIFEST }}
            - path: `${{ env.S5_JSON_PATH }}`
          commit-message: "chore(ask): add S5 apply inbox for #${{ env.S5_PR }}"
          labels: |
            evidence
            kind:s5-apply

      - name: Commit inbox JSON into PR branch
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git status --short
          git add "${ASK_FILE}"

          git diff --cached --quiet && {
            echo "No changes to commit; exiting."
            exit 0
          }

          git commit -m "ask: add codex inbox payload (${ASK_FILE})"
          git push
