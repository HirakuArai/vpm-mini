name: DoD Enforcer
on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review, reopened, labeled]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  enforce:
    name: Enforce DoD Compliance
    runs-on: ubuntu-latest
    steps:
      # 1) ãƒ©ãƒ™ãƒ«ã‚’APIã§å–å¾—ã—ã¦åˆ†å²ãƒ•ãƒ©ã‚°ã‚’å‡ºåŠ›
      - id: check_label
        name: Check skip-dod label via API
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo, number} = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: context.payload.pull_request.number
            };
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number: number });
            const names = labels.map(l => l.name);
            core.info('labels: ' + names.join(','));
            const bypass = names.includes('skip-dod') ? 'true' : 'false';
            core.setOutput('bypass', bypass);
            if (bypass === 'true') {
              core.notice('skip-dod present â†’ bypass DoD');
            }

      # 2) bypass ã®ã¨ãã¯ã“ã“ã§æˆåŠŸçµ‚äº†ï¼ˆRequired ã‚’æº€ãŸã™ï¼‰
      - name: Bypass DoD (success)
        if: ${{ steps.check_label.outputs.bypass == 'true' }}
        run: |
          echo "DoD bypassed by skip-dod label (temporary)."
          exit 0

      # 3) é€šå¸¸ã®DoDãƒã‚§ãƒƒã‚¯ï¼ˆæœ¬æ–‡ã®å®Œå…¨ä¸€è‡´åˆ¤å®šï¼‰
      - name: Check DoD compliance (safe mode)
        if: ${{ steps.check_label.outputs.bypass != 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const body = (context.payload.pull_request?.body || "");
              const required = [
                "Auto-merge (squash) æœ‰åŠ¹åŒ–",
                "CI å¿…é ˆãƒã‚§ãƒƒã‚¯ Greenï¼ˆtest-and-artifacts, healthcheckï¼‰",
                "merged == true ã‚’ API ã§ç¢ºèª",
                "PR ã«æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆâœ… merged / commit hash / CI run URL / evidenceï¼‰",
                "å¿…è¦ãªè¨¼è·¡ï¼ˆä¾‹: reports/*ï¼‰ã‚’æ›´æ–°"
              ];
              const missing = required.filter(item => !body.includes(item));
              if (missing.length) {
                console.log("âŒ DoD Compliance Check Failed");
                console.log("================================");
                console.log("Missing items:");
                missing.forEach(item => console.log(`  - ${item}`));
                console.log("\nðŸ“‹ Copy and paste this complete DoD checklist to your PR body:");
                console.log("```");
                console.log("## DoD ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆç·¨é›†ä¸å¯ãƒ»å®Œå…¨ä¸€è‡´ï¼‰");
                console.log("- [x] Auto-merge (squash) æœ‰åŠ¹åŒ–");
                console.log("- [x] CI å¿…é ˆãƒã‚§ãƒƒã‚¯ Greenï¼ˆtest-and-artifacts, healthcheckï¼‰");
                console.log("- [x] merged == true ã‚’ API ã§ç¢ºèª");
                console.log("- [x] PR ã«æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆâœ… merged / commit hash / CI run URL / evidenceï¼‰");
                console.log("- [x] å¿…è¦ãªè¨¼è·¡ï¼ˆä¾‹: reports/*ï¼‰ã‚’æ›´æ–°");
                console.log("```");
                console.log("================================");
                core.setFailed(`DoD missing ${missing.length} items: ${missing.join(", ")}`);
              } else {
                console.log("âœ… DoD Compliance Check Passed");
                required.forEach(item => console.log(`  âœ“ ${item}`));
                core.notice("âœ… DoD OK - All required items present");
              }
            } catch (e) {
              core.setFailed("DoD script error: " + (e?.message || String(e)));
            }
