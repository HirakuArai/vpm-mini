name: DoD Enforcer
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  enforce:
    name: Enforce DoD Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Wait for Evidence commit from pr-validate
        run: |
          set -euo pipefail
          BR="${{ github.event.pull_request.head.ref }}"
          for i in {1..40}; do
            if ls reports/p2_2_hello_ksvc_*.md >/dev/null 2>&1; then
              echo "Evidence found"; break
            fi
            echo "Evidence not yet present; waiting 15s..."
            sleep 15
            git fetch origin "$BR"
            git checkout -q FETCH_HEAD
          done
          ls reports/p2_2_hello_ksvc_*.md >/dev/null 2>&1 || { echo "Evidence timeout"; exit 1; }

      - name: Enforce DoD
        run: bash scripts/dod_enforcer.sh