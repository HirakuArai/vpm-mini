name: DoD Enforcer
on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review, reopened]
  workflow_dispatch:

permissions:
  contents: read            # ← 読み取りのみ（コメント投稿はしない）

jobs:
  enforce:
    name: Enforce DoD Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Check DoD compliance (safe mode)
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const body = (context.payload.pull_request?.body || "");
              const required = [
                "Auto-merge (squash) 有効化",
                "CI 必須チェック Green（test-and-artifacts, healthcheck）",
                "merged == true を API で確認",
                "PR に最終コメント（✅ merged / commit hash / CI run URL / evidence）",
                "必要な証跡（例: reports/*）を更新"
              ];
              const missing = required.filter(item => !body.includes(item));
              if (missing.length) {
                core.setFailed("DoD missing: " + missing.join(", "));
              } else {
                core.notice("✅ DoD OK");
              }
            } catch (e) {
              core.setFailed("DoD script error: " + (e?.message || String(e)));
            }