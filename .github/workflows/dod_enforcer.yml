name: DoD Enforcer
on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review, reopened]
  workflow_dispatch:

permissions:
  contents: read            # â† èª­ã¿å–ã‚Šã®ã¿ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã¯ã—ãªã„ï¼‰

jobs:
  enforce:
    name: Enforce DoD Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Bypass DoD via label
        if: ${{ contains(join(github.event.pull_request.labels.*.name, ','), 'skip-dod') }}
        run: |
          echo "skip-dod label present â†’ DoD passed (temporary bypass)."
          exit 0
      - name: Check DoD compliance (safe mode)
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const body = (context.payload.pull_request?.body || "");
              const required = [
                "Auto-merge (squash) æœ‰åŠ¹åŒ–",
                "CI å¿…é ˆãƒã‚§ãƒƒã‚¯ Greenï¼ˆtest-and-artifacts, healthcheckï¼‰",
                "merged == true ã‚’ API ã§ç¢ºèª",
                "PR ã«æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆâœ… merged / commit hash / CI run URL / evidenceï¼‰",
                "å¿…è¦ãªè¨¼è·¡ï¼ˆä¾‹: reports/*ï¼‰ã‚’æ›´æ–°"
              ];
              const missing = required.filter(item => !body.includes(item));
              
              if (missing.length) {
                // Generate helpful output with copy-paste ready block
                console.log("âŒ DoD Compliance Check Failed");
                console.log("================================");
                console.log("Missing items:");
                missing.forEach(item => console.log(`  - ${item}`));
                console.log("\nðŸ“‹ Copy and paste this complete DoD checklist to your PR body:");
                console.log("```");
                console.log("## DoD ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆç·¨é›†ä¸å¯ãƒ»å®Œå…¨ä¸€è‡´ï¼‰");
                console.log("- [x] Auto-merge (squash) æœ‰åŠ¹åŒ–");
                console.log("- [x] CI å¿…é ˆãƒã‚§ãƒƒã‚¯ Greenï¼ˆtest-and-artifacts, healthcheckï¼‰");
                console.log("- [x] merged == true ã‚’ API ã§ç¢ºèª");
                console.log("- [x] PR ã«æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆâœ… merged / commit hash / CI run URL / evidenceï¼‰");
                console.log("- [x] å¿…è¦ãªè¨¼è·¡ï¼ˆä¾‹: reports/*ï¼‰ã‚’æ›´æ–°");
                console.log("```");
                console.log("\nðŸ’¡ Tip: The DoD Autofix workflow will automatically add missing items.");
                console.log("================================");
                
                core.setFailed(`DoD missing ${missing.length} items: ${missing.join(", ")}`);
              } else {
                console.log("âœ… DoD Compliance Check Passed");
                console.log("================================");
                console.log("All required DoD items found in PR body:");
                required.forEach(item => console.log(`  âœ“ ${item}`));
                console.log("================================");
                core.notice("âœ… DoD OK - All required items present");
              }
            } catch (e) {
              core.setFailed("DoD script error: " + (e?.message || String(e)));
            }
