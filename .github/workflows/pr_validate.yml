name: pr-validate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  k8s-validate:
    name: k8s-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Kustomize build only
        run: |
          set -euo pipefail

          cd infra/k8s/overlays/dev

          echo "Building kustomize..."
          kubectl kustomize . > /tmp/manifest.yaml

          echo "✅ Kustomize build passed ($(wc -l < /tmp/manifest.yaml) lines)"
          echo "Note: kubectl apply --dry-run skipped (requires cluster)"

  knative-ready:
    name: knative-ready
    needs: [k8s-validate]
    runs-on: ubuntu-latest
    outputs:
      ksvc_b64: ${{ steps.export_yaml.outputs.b64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup KinD
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: vpm-test
          wait: 60s

      - name: Install Knative Serving
        run: |
          set -euo pipefail

          echo "Installing Knative Serving v1.15.0..."
          kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.15.0/serving-crds.yaml
          kubectl wait --for=condition=Established --all crd --timeout=120s

          kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.15.0/serving-core.yaml
          kubectl wait --for=condition=Available --all deployments -n knative-serving --timeout=360s

          echo "Installing Kourier networking..."
          kubectl apply -f https://github.com/knative/net-kourier/releases/download/knative-v1.15.0/kourier.yaml
          kubectl wait --for=condition=Available --all deployments -n kourier-system --timeout=360s

          kubectl patch configmap/config-network \
            --namespace knative-serving \
            --type merge \
            --patch '{"data":{"ingress-class":"kourier.ingress.networking.knative.dev"}}'

          echo "Configuring DNS..."
          kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.15.0/serving-default-domain.yaml

          echo "✅ Knative Serving installed"

      - name: Apply Knative Service
        run: |
          set -euo pipefail

          KSVC_PATH="infra/k8s/overlays/dev/hello-ksvc.yaml"

          if [ ! -f "$KSVC_PATH" ]; then
            echo "::error::$KSVC_PATH not found"
            exit 1
          fi

          echo "Applying Knative Service from $KSVC_PATH..."
          kubectl apply -f "$KSVC_PATH"

      - name: Ensure serving/kourier deployments are Available
        run: |
          set -euo pipefail
          kubectl -n knative-serving get deploy -o name | xargs -I{} kubectl -n knative-serving rollout status {} --timeout=5m
          kubectl -n kourier-system get deploy -o name | xargs -I{} kubectl -n kourier-system rollout status {} --timeout=5m

      - name: Wait for READY=True (robust)
        run: |
          set -euo pipefail
          kubectl wait --for=condition=Ready ksvc/hello -n default --timeout=10m
          # API反映の揺れ対策：少し待ってから取得→最大60秒リトライで True を確認
          for i in $(seq 1 12); do
            kubectl get ksvc hello -n default -oyaml > /tmp/ksvc_ready.yaml
            # Simple grep-based detection for robustness
            if grep -A5 'type: Ready' /tmp/ksvc_ready.yaml | grep -q 'status: "True"'; then
              R="True"
            elif grep -A5 'type: Ready' /tmp/ksvc_ready.yaml | grep -q 'status: True'; then
              R="True"
            else
              R="Unknown"
            fi
            echo "knative-ready: probe[$i] READY=$R"
            [ "$R" = "True" ] && break
            sleep 5
          done
          grep -q 'type: Ready' /tmp/ksvc_ready.yaml || { echo "::error::No Ready condition in YAML"; exit 1; }
          grep -A5 'type: Ready' /tmp/ksvc_ready.yaml | grep -Eq 'status:[[:space:]]+"?True"?' || { echo "::error::Ready!=True after retries"; cat /tmp/ksvc_ready.yaml; exit 1; }

      - name: Export KSVC YAML as output (b64)
        id: export_yaml
        run: |
          set -euo pipefail
          # base64（改行なし）
          if base64 --help 2>&1 | grep -q '\-w'; then
            B64=$(base64 -w0 /tmp/ksvc_ready.yaml)
          else
            B64=$(base64 /tmp/ksvc_ready.yaml | tr -d '\n')
          fi
          printf 'b64=%s\n' "$B64" >> "$GITHUB_OUTPUT"
          echo "knative-ready: exported YAML length=${#B64}"

      - name: Upload KSVC State (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ksvc-state
          path: /tmp/ksvc_ready.yaml
          if-no-files-found: ignore

  evidence-dod:
    name: evidence-dod
    needs: [k8s-validate, knative-ready]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yq (v4)
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Reconstruct KSVC YAML from job output
        id: reconstruct
        run: |
          set -euo pipefail
          B64="${{ needs.knative-ready.outputs.ksvc_b64 }}"
          L=${#B64}
          echo "evidence-dod: received b64 length=$L"
          test "$L" -gt 0 || { echo "::error::empty ksvc_b64 output"; exit 1; }
          echo "$B64" | base64 -d > /tmp/ksvc_ready.yaml
          echo "evidence-dod: reconstructed YAML:"
          head -n 25 /tmp/ksvc_ready.yaml || true

      - name: Generate Evidence (MD)
        id: gen
        run: |
          set -euo pipefail
          chmod +x scripts/gen_evidence_kservice_ready.sh
          ./scripts/gen_evidence_kservice_ready.sh /tmp/ksvc_ready.yaml

      - name: Enforce DoD from YAML (strict)
        run: |
          set -euo pipefail
          R=$(yq -r '.status.conditions[] | select(.type=="Ready") | .status' /tmp/ksvc_ready.yaml || echo "Unknown")
          echo "evidence-dod: extracted READY=$R from YAML"
          yq -e '.status.conditions[] | select(.type=="Ready") | .status == "True"' /tmp/ksvc_ready.yaml >/dev/null
          echo "evidence-dod: DoD OK - READY=True enforced"

      - name: Upload Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-reports
          path: reports/*.md