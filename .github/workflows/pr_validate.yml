name: pr-validate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  k8s-validate:
    name: k8s-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Kustomize build only
        run: |
          set -euo pipefail

          cd infra/k8s/overlays/dev

          echo "Building kustomize..."
          kubectl kustomize . > /tmp/manifest.yaml

          echo "✅ Kustomize build passed ($(wc -l < /tmp/manifest.yaml) lines)"
          echo "Note: kubectl apply --dry-run skipped (requires cluster)"

  knative-ready:
    name: knative-ready
    needs: [k8s-validate]
    runs-on: ubuntu-latest
    outputs:
      ksvc_b64: ${{ steps.export_yaml.outputs.b64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup KinD
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: vpm-test
          wait: 60s

      - name: Install Knative Serving
        run: |
          set -euo pipefail

          echo "Installing Knative Serving v1.15.0..."
          kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.15.0/serving-crds.yaml
          kubectl wait --for=condition=Established --all crd --timeout=120s

          kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.15.0/serving-core.yaml
          kubectl wait --for=condition=Available --all deployments -n knative-serving --timeout=360s

          echo "Installing Kourier networking..."
          kubectl apply -f https://github.com/knative/net-kourier/releases/download/knative-v1.15.0/kourier.yaml
          kubectl wait --for=condition=Available --all deployments -n kourier-system --timeout=360s

          kubectl patch configmap/config-network \
            --namespace knative-serving \
            --type merge \
            --patch '{"data":{"ingress-class":"kourier.ingress.networking.knative.dev"}}'

          echo "Configuring DNS..."
          kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.15.0/serving-default-domain.yaml

          echo "✅ Knative Serving installed"

      - name: Apply Knative Service
        run: |
          set -euo pipefail

          KSVC_PATH="infra/k8s/overlays/dev/hello-ksvc.yaml"

          if [ ! -f "$KSVC_PATH" ]; then
            echo "::error::$KSVC_PATH not found"
            exit 1
          fi

          echo "Applying Knative Service from $KSVC_PATH..."
          kubectl apply -f "$KSVC_PATH"

      - name: Ensure serving/kourier deployments are Available
        run: |
          set -euo pipefail
          kubectl -n knative-serving  rollout status deploy --all --timeout=5m
          kubectl -n kourier-system   rollout status deploy --all --timeout=5m

      - name: Wait for READY=True (robust)
        run: |
          set -euo pipefail
          # 1) 公式に Ready を待つ（最大10分）
          kubectl wait --for=condition=Ready ksvc/hello -n default --timeout=10m
          # 2) 直後の整合待ち
          sleep 5
          # 3) 取得→保存
          kubectl get ksvc hello -n default -oyaml > /tmp/ksvc_ready.yaml

      - name: Verify saved YAML is READY=True
        run: |
          set -euo pipefail
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq -e '.status.conditions[] | select(.type=="Ready") | .status == "True"' /tmp/ksvc_ready.yaml >/dev/null

      - name: Export KSVC YAML as output (b64)
        id: export_yaml
        run: |
          set -euo pipefail
          if base64 --help 2>&1 | grep -q '\-w'; then
            b64=$(base64 -w0 /tmp/ksvc_ready.yaml)
          else
            b64=$(base64 /tmp/ksvc_ready.yaml | tr -d '\n')
          fi
          echo "b64=$b64" >> "$GITHUB_OUTPUT"

      - name: Upload KSVC State (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ksvc-state
          path: /tmp/ksvc_ready.yaml
          if-no-files-found: ignore

  evidence-dod:
    name: evidence-dod
    needs: [k8s-validate, knative-ready]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yq (v4)
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Reconstruct KSVC YAML from job output
        id: reconstruct
        run: |
          set -euo pipefail
          echo "${{ needs.knative-ready.outputs.ksvc_b64 }}" | base64 -d > /tmp/ksvc_ready.yaml
          ls -l /tmp/ksvc_ready.yaml
          head -n 20 /tmp/ksvc_ready.yaml || true

      - name: Generate Evidence (MD)
        id: gen
        run: |
          set -euo pipefail
          chmod +x scripts/gen_evidence_kservice_ready.sh
          ./scripts/gen_evidence_kservice_ready.sh /tmp/ksvc_ready.yaml

      - name: Enforce DoD from YAML (strict)
        run: |
          set -euo pipefail
          yq -e '.status.conditions[] | select(.type=="Ready") | .status == "True"' /tmp/ksvc_ready.yaml >/dev/null
          echo "DoD OK: Ready=True"

      - name: Upload Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-reports
          path: reports/*.md