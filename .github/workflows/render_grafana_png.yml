name: render-grafana-png
on:
  schedule:
    - cron: "0 0 * * *"  # 09:00 JST (UTC 00:00)
  workflow_dispatch:
    inputs:
      from:
        description: 'time range from'
        default: 'now-30m'
      to:
        description: 'time range to'
        default: 'now'
permissions:
  contents: write
  pull-requests: write
  actions: read

concurrency:
  group: render-grafana-png-${{ github.ref }}
  cancel-in-progress: true
jobs:
  render:
    strategy:
      matrix:
        include:
          - uid: vpm-basic-observability
            panelId: "2"
            evidence_prefix: grafana_p3_2_auto
          - uid: p4-uptime-blackbox
            panelId: ""
            evidence_prefix: grafana_p4-uptime-blackbox
    runs-on: [self-hosted, local-mac]
    timeout-minutes: 20
    env:
      LOCAL_URL: http://127.0.0.1:3000
      GRAFANA_NS: monitoring
      GRAFANA_SVC: kps-grafana
      UID: ${{ matrix.uid }}
      PANEL_ID: ${{ matrix.panelId }}
      EVIDENCE_PREFIX: ${{ matrix.evidence_prefix }}
      FROM: ${{ github.event.inputs.from || 'now-30m' }}
      TO: ${{ github.event.inputs.to || 'now' }}
    steps:
      - name: Start Grafana port-forward
        run: |
          set -euo pipefail
          echo "Starting kubectl port-forward for ${GRAFANA_SVC} in ns=${GRAFANA_NS} → 127.0.0.1:3000"
          kubectl -n "${GRAFANA_NS}" port-forward "svc/${GRAFANA_SVC}" 3000:80 >/dev/null 2>&1 &
          echo $! > pf.pid
          for i in $(seq 1 30); do
            if curl -sfS "$LOCAL_URL/api/health" >/dev/null; then
              echo "Grafana is reachable (attempt $i)"
              break
            fi
            sleep 1
          done
          curl -sfS "$LOCAL_URL/api/health" >/dev/null || { echo "Grafana not reachable after waiting"; exit 1; }
      - uses: actions/checkout@v4

      - name: Resolve render target
        run: |
          set -euo pipefail
          echo "Rendering UID=${UID} PANEL_ID=${PANEL_ID:-<none>} range ${FROM} → ${TO}"

      - name: Health check
        run: curl -fsS "$LOCAL_URL/api/health" >/dev/null

      - name: Render PNG via /render
        env:
          GRAFANA_USER: ${{ secrets.GRAFANA_USER }}
          GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${GRAFANA_USER:-}" ] || [ -z "${GRAFANA_PASSWORD:-}" ]; then
            echo "Grafana credentials secrets are required" >&2
            exit 1
          fi
          TS="$(date +%Y%m%d_%H%M%S)"
          PREFIX="${EVIDENCE_PREFIX:-${UID}}"
          OUT="reports/img/${PREFIX}_${TS}.png"
          mkdir -p reports/img
          AUTH=(-u "${GRAFANA_USER}:${GRAFANA_PASSWORD}")
          if [ -n "${PANEL_ID:-}" ]; then
            curl -fsS "${AUTH[@]}" \
              "${LOCAL_URL}/render/d-solo/${UID}?orgId=1&from=${FROM}&to=${TO}&panelId=${PANEL_ID}&width=1600&height=900" \
              -o "$OUT"
          else
            curl -fsS "${AUTH[@]}" \
              "${LOCAL_URL}/render/d/${UID}?orgId=1&from=${FROM}&to=${TO}&width=1600&height=900" \
              -o "$OUT"
          fi
          echo "OUT=$OUT" >> "$GITHUB_ENV"

      - name: Note evidence UID
        run: echo "EVIDENCE UID: ${UID} PANEL: ${PANEL_ID:-none}"
      - name: Append Evidence MD
        run: |
          set -euo pipefail
          TS=$(date +%Y%m%d_%H%M%S)
          PREFIX="${EVIDENCE_PREFIX:-${UID}}"
          EV="reports/${PREFIX}_grafana_render_${TS}.md"
          REL="${OUT#reports/}"
          {
            echo "# Grafana render @ ${TS}"
            echo "- dashboard uid: ${UID}"
            echo "- panel id: ${PANEL_ID:-<none>}"
            echo "- range: ${FROM} → ${TO}"
            echo
            echo "![render](${REL})"
          } > "$EV"

      - name: Create PR with artifacts
        uses: peter-evans/create-pull-request@v6
        id: create_pr
        with:
          token: ${{ secrets.PR_BOT_TOKEN }}
          commit-message: "chore(render): add Grafana evidence (${UID})"
          title: "chore(render): auto-render evidence (${UID})"
          body: |
            Auto-generated evidence from workflow run ${{ github.run_id }}.
            - Dashboard UID: ${UID}
            - Panel ID: ${PANEL_ID:-<none>}
            - Range: ${FROM} → ${TO}
          branch: "bot/render/${{ github.run_id }}"
          add-paths: |
            reports/*_grafana_render_*.md
            reports/img/grafana_*.png
          labels: p3-2,evidence,bot
          delete-branch: true
      - name: Echo Evidence PR URL (if created)
        if: ${{ steps.create_pr.outputs.pull-request-url != '' }}
        run: |
          echo "Evidence PR: ${{ steps.create_pr.outputs.pull-request-url }}"
      - name: Cleanup port-forward
        if: always()
        run: |
          if [ -f pf.pid ]; then
            kill "$(cat pf.pid)" 2>/dev/null || true
            rm -f pf.pid
          fi

# TODO: wire dashboard UID into this workflow
# Suggested UID: "p4-uptime-blackbox" (current workflow renders a single dashboard via infra/observability/grafana-dashboard-basic.json)
