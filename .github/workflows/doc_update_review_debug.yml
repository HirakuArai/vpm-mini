name: Doc Update Review Debug (Sho v2)

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: "Target project_id (e.g. vpm-mini, hakone-e2)"
        required: true
        default: "hakone-e2"
      proposal_path:
        description: "Path to doc_update_proposal_v1 JSON in the repo"
        required: true
        default: "reports/doc_update_proposals/2025-11-24-vpm-mini.json"

jobs:
  review_doc_update_proposal:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate proposal JSON exists
        run: |
          PROPOSAL_PATH="${{ github.event.inputs.proposal_path }}"
          if [ ! -f "${PROPOSAL_PATH}" ]; then
            echo "Proposal JSON not found: ${PROPOSAL_PATH}" >&2
            exit 1
          fi
          echo "[Sho debug] Found proposal JSON: ${PROPOSAL_PATH}"

      - name: Generate doc_update_review_v1 via Python (placeholder)
        env:
          PROPOSAL_PATH: ${{ github.event.inputs.proposal_path }}
          PROJECT_ID: ${{ github.event.inputs.project_id }}
        run: |
          python - << 'PY'
          import json, os, datetime, pathlib

          proposal_path = os.environ["PROPOSAL_PATH"]
          project_id = os.environ["PROJECT_ID"]
          now = datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z"

          data = {
              "schema_version": "doc_update_review_v1",
              "project_id": project_id,
              "proposal_ref": proposal_path,
              "generated_at": now,
              "overall_assessment": {
                  "summary": "placeholder review by Sho debug: このレビューは枠組みテスト用のダミーです。",
                  "risk_level": "low",
              },
              "update_judgements": [
                  {
                      "target_path": "STATE/vpm-mini/current_state.md",
                      "section_hint": "n/a (placeholder)",
                      "decision": "accept",
                      "reason": "placeholder: 本番実装では proposal.json を解析して judgement を生成します。",
                  }
              ],
              "notes": [
                  "この doc_update_review_v1.json は Doc Update Review Debug workflow の枠組みテスト用です。",
                  "将来、Sho は proposal.json の中身を読み、各 updates に対する judgement を生成します。",
              ],
          }

          out = pathlib.Path("doc_update_review_v1.json")
          out.write_text(json.dumps(data, ensure_ascii=False, indent=2), encoding="utf-8")
          print(f"Wrote {out}")
          PY

      - name: Upload review JSON as artifact
        uses: actions/upload-artifact@v4
        with:
          name: doc_update_review_v1_${{ github.event.inputs.project_id }}
        
          path: doc_update_review_v1.json
