name: Doc Update Review Debug (Sho v2)

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: "Target project_id (e.g. vpm-mini, hakone-e2)"
        required: true
        default: "hakone-e2"
      proposal_path:
        description: "Path to doc_update_proposal_v1 JSON in the repo"
        required: true
        default: "reports/doc_update_proposals/2025-11-24-vpm-mini.json"

jobs:
  review_doc_update_proposal:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Resolve and validate proposal JSON
        env:
          PROJECT_ID: ${{ github.event.inputs.project_id }}
          INPUT_PROPOSAL_PATH: ${{ github.event.inputs.proposal_path }}
        run: |
          PROJECT_ID="${PROJECT_ID}"
          PROPOSAL_PATH="${INPUT_PROPOSAL_PATH}"

          if [ -z "${PROPOSAL_PATH}" ]; then
            echo "[Sho v1] proposal_path が空なので、最新の proposal を自動検出します..."
            latest=$(ls -1 "reports/doc_update_proposals/"*"_${PROJECT_ID}".json 2>/dev/null | sort | tail -n 1 || true)
            if [ -z "${latest}" ]; then
              echo "No proposal JSON found for project_id=${PROJECT_ID} under reports/doc_update_proposals/" >&2
              exit 1
            fi
            PROPOSAL_PATH="${latest}"
          fi

          if [ ! -f "${PROPOSAL_PATH}" ]; then
            echo "Proposal JSON not found: ${PROPOSAL_PATH}" >&2
            exit 1
          fi

          echo "[Sho v1] Using proposal JSON: ${PROPOSAL_PATH}"
          echo "PROPOSAL_PATH=${PROPOSAL_PATH}" >> "$GITHUB_ENV"

      - name: Generate doc_update_review_v1 via Python (Sho v1)
        env:
          PROPOSAL_PATH: ${{ env.PROPOSAL_PATH }}
          PROJECT_ID: ${{ github.event.inputs.project_id }}
        run: |
          python - << 'PY'
          import json, os, datetime, pathlib

          proposal_path = os.environ["PROPOSAL_PATH"]
          project_id = os.environ["PROJECT_ID"]

          with open(proposal_path, encoding="utf-8") as f:
              proposal = json.load(f)

          updates = proposal.get("updates", [])
          no_change = proposal.get("no_change", [])

          confidences = {u.get("confidence", "") for u in updates}
          if "low" in confidences:
              risk_level = "high"
          elif "medium" in confidences:
              risk_level = "medium"
          else:
              risk_level = "low"

          # overall summary
          conf_summary = ", ".join(sorted(c for c in confidences if c)) or "n/a"
          overall_summary = (
              f"{project_id} 向け doc_update_proposal_v1 に対する Sho v1 の自動レビュー。"
              f" updates={len(updates)} 件, no_change={len(no_change)} 件, "
              f"confidence 分布={conf_summary}。"
          )

          update_judgements = []
          for u in updates:
              target = u.get("target", {})
              path = target.get("path", "")
              section_hint = target.get("section_hint", "")
              conf = u.get("confidence", "")
              base_reason = (u.get("reason") or "").strip()

              if conf == "low":
                  decision = "reject"
                  reason = (
                      "confidence=low のため、Sho v1 としては自動採用せず、人間レビューを強く推奨します。"
                  )
              elif conf == "medium":
                  decision = "accept"
                  reason = (
                      "confidence=medium のため、自動採用は可能ですが、人間レビューを推奨します。"
                  )
              else:
                  decision = "accept"
                  reason = (
                      "confidence=high のため、Sho v1 としては自動採用してよいと判断します。"
                  )

              if base_reason:
                  reason = reason + f" 提案者の理由: {base_reason}"

              update_judgements.append(
                  {
                      "target_path": path,
                      "section_hint": section_hint,
                      "decision": decision,
                      "reason": reason,
                  }
              )

          now = datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z"

          data = {
              "schema_version": "doc_update_review_v1",
              "project_id": project_id,
              "proposal_ref": proposal_path,
              "generated_at": now,
              "overall_assessment": {
                  "summary": overall_summary,
                  "risk_level": risk_level,
              },
              "update_judgements": update_judgements,
              "notes": [
                  "この doc_update_review_v1.json は Sho v1 による自動レビュー結果です。",
                  "最終的な採否の判断は、人間（啓＋ChatGPT）による確認を前提としています。",
                  "confidence と対象ドキュメントの種類に基づき、accept/reject と human review の必要度を示しています。",
              ],
          }

          out = pathlib.Path("doc_update_review_v1.json")
          out.write_text(json.dumps(data, ensure_ascii=False, indent=2), encoding="utf-8")
          print(f"Wrote {out}")
          PY

      - name: Upload review JSON as artifact
        uses: actions/upload-artifact@v4
        with:
          name: doc_update_review_v1_${{ github.event.inputs.project_id }}
          path: doc_update_review_v1.json
