# Step <N>: <TITLE>（1PR = 1ステップ）

**目的**  
<TITLE> を実装し、DoDを満たした状態で main に取り込む。

**DoD**  
- CI green
- Auto-merge 設定済み
- MERGED 状態確認
- `reports/snap_<SLUG>.md` 生成
- Git tag `<SLUG>` 付与

**変更予定**  
<FILES>

**実行フロー（Claude Code用）**

1. **作業ブランチ作成**
```bash
git checkout -b feat/<SLUG>
```

2. **ファイル変更**
（実装詳細に応じてファイル編集）

3. **コミット & PR作成**
```bash
git add <FILES_FLAT>
git commit -m "feat: <SLUG> – <TITLE>"
git push -u origin HEAD
gh pr create --title "feat: <SLUG> – <TITLE>" --body "<TITLE>実装完了"
gh pr edit --add-label "auto-merge,phase2"
gh pr merge --auto --squash
```

4. **CI監視 & MERGED確認**
```bash
# CI状態チェック
gh pr checks --watch

# MERGED状態確認
gh pr view --json state -q .state
```

5. **main取得 → snapshot生成 → tag**
```bash
git fetch origin main && git checkout main && git pull
python scripts/make_snapshot.py --slug "<SLUG>" \
  --dod "<DOD_TEXT>" \
  --changes "<TITLE>完了" \
  --ci_url "$(gh pr view --json url -q .url)"
git add reports/snap_<SLUG>.md
git commit -m "chore: snapshot <SLUG>"
git tag <SLUG>
git push origin main --tags
```

**失敗時ハンドリング**
- CI red: 修正 → 再push
- 競合: Auto-merge維持 → 解消コミット → 再push  
- タイムアウト: 状況要約を出力して停止
---

<!-- VERIFICATION_SUITE_START: do not remove -->
### ✅ Verification Suite（MERGED / snapshot / tag）

```bash
# ---- Verification Suite: MERGED / snapshot / tag ----
set -euo pipefail

# 1) PR が本当に MERGED になっているか
PR_NUM="${PR_NUM:?set PR_NUM}"
gh pr view "$PR_NUM" --json state,mergedAt,mergeCommit,url \
  -q '"state=" + .state + " mergedAt=" + (.mergedAt//"") + " mergeCommit=" + (.mergeCommit.abbreviatedOid//"") + " url=" + .url'
STATE=$(gh pr view "$PR_NUM" --json state -q .state)
test "$STATE" = "MERGED"

# 2) snapshot ファイルが origin/main に存在するか
SLUG="${SLUG:?set SLUG}"
git fetch origin main >/dev/null
git cat-file -e "origin/main:reports/snap_${SLUG}.md" \
  && echo "OK: reports/snap_${SLUG}.md on origin/main" \
  || { echo "MISSING: reports/snap_${SLUG}.md on origin/main"; exit 1; }

# 3) タグがリモートに存在するか
git ls-remote --tags origin | grep -q "refs/tags/${SLUG}" \
  && echo "OK: tag ${SLUG} on remote" \
  || { echo "MISSING: tag ${SLUG} on remote"; exit 1; }

echo "✅ Verification passed for ${SLUG}"
```

<!-- VERIFICATION_SUITE_END -->
