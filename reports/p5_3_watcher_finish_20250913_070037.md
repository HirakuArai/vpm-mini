# P5-3 Finisher: watcher image/env/health/metrics â€” 20250913_070037

## Image
- ghcr.io/hirakuarai/hello-ai:1.0.3 (placeholder - hello-ai service used instead of actual watcher)

## Environment Migration
- ConfigMap: watcher-config (created with ROLE, PORT, METRICS_PORT, TRACE_ID)
- Secret(ESO/SOPS PoC): No secrets detected in compose environment variables
- SOPS configuration: Created .sops.yaml with age encryption key

## Health & Metrics
- readinessProbe: /healthz:8001 (configured but failing due to placeholder image)
- metrics Service: watcher-metrics:9001
- ServiceMonitor: monitoring/watcher (release label: vpm-mini-kube-prometheus-stack)

## Files Created/Updated
- infra/k8s/overlays/dev/watcher/ksvc.yaml: Updated with envFrom and readinessProbe
- infra/k8s/overlays/dev/watcher/configmap.yaml: Environment variables from compose
- infra/k8s/overlays/dev/watcher/svc-metrics.yaml: Metrics service on port 9001
- infra/k8s/overlays/dev/monitoring/servicemonitor-watcher.yaml: Prometheus ServiceMonitor
- .sops.yaml: SOPS configuration for secret encryption
- infra/secrets/keys/cluster.agekey: Age encryption key for SOPS

## Deployment Status
- ksvc READY=Unknown (RevisionMissing - readiness probe failing)
- Pod Status: 1/2 containers ready (main container running, queue-proxy failing readiness)
- Main container started successfully with environment variables
- Warm-up: Skipped (readiness probe failing due to missing /healthz endpoint)

## Verification
- ConfigMap watcher-config created and referenced in KService
- Metrics Service watcher-metrics created on port 9001
- ServiceMonitor created in monitoring namespace for Prometheus scraping
- Pod running with proper environment variable injection

## Next Steps for Production
1. **Build actual watcher image** with proper /healthz endpoint
2. **Add metrics endpoint** at /metrics on port 9001
3. **Implement proper health checks** matching the application
4. **Migrate to actual SOPS secrets** for sensitive environment variables
5. **Test end-to-end functionality** with real watcher service code

## ESO/SOPS Setup Status
- Age encryption key generated for cluster
- SOPS configuration file created
- Ready for secret encryption workflow
- ConfigMap approach used for non-sensitive env vars
