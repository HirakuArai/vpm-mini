# 引き継ぎサマリー（Feature-Confirmation 体制）

## 0) プロジェクト概要（ねらい）
- 目的：**AIが副PMとして PR 単位で 提案→検証→反映→証跡化 を自動運転**し、**EG-Space（事象目的空間）**で"正しい方向（⃗d）とズレ（δ）"を可視化できる運用をつくる。
- 構成：**GitHub（PR/Actions） × VS Code/Claude Code × Kubernetes/Knative × Prometheus/Grafana × Gatekeeper/SPIRE**。AI APIは**既定OFF**（必要時のみON）。

## 1) 現在地（C）と復元点（タグ）
- **Phase 1（KPI可視化・実データ配線）**：✅ 完了  
  - p50 latency：Prometheus 実配線  
  - JSON error rate：`revision_app_request_count`（:9091）実配線  
  - ROUGE-L：Pushgateway→`vpm_rouge_l_score` 実配線  
  - タグ：`p1-kpi-green-20250908`
- **Phase 2（小規模Swarm/実運用）**：✅ 最小実証完了  
  - Autoscale：1→3 pods（200並行×120s）  
  - Cold-start：≈84ms（warm中央値 ≈16ms）  
  - タグ：`p2-autoscale-green-20250908`、`p2-coldstart-green-20250908`
- **Phase 3（監査・セキュリティ）**：✅ 主要機能完了  
  - Gatekeeper：allowed-repos / no-latest + DENY 証跡  
  - SPIRE：SVID 付与（例 `spiffe://…/ns/hyper-swarm/sa/default`）  
  - PROV：決定ログ（最小→拡張）  
  - Chaos（pod-kill）× KPI ダッシュボード（Chaos Audit）  
  - タグ例：`p3-1-green-20250905`、`p3-2-1-green-20250907`、`p3-2-2-green-20250907`、`p3-2-3-green-20250907`、`p3-2-4-green-20250907`、`p3-3-podkill-green-20250908`、`p3-4-chaos-audit-green-YYYYMMDD`  
> すべて **STATE/current_state.md** に記録、**reports/** に証跡あり。

## 2) 環境と主要パス
- Prometheus/Pushgateway：`infra/k8s/overlays/dev/monitoring/prometheus.yaml`、`monitoring/pushgateway:9091`
- Grafana DS：`grafana/provisioning/datasources/ds.yml`（`uid: prom-k8s` → `http://prometheus.monitoring.svc:9090`）  
- Dashboards：`grafana/provisioning/dashboards/phase1_kpi.json` / `…/chaos_audit.json`
- 監査：Gatekeeper（Constraints）、SPIRE（`spire-system`）  
- PROV：`reports/prov_p3_2_4_*.jsonld`
- Demo v1：`runbooks/demo_v1.md` / `ui/demo-ui/app.py` / `scripts/egspace_min.py`

## 3) 運用（Operating Contract：要点）
- **GPT**：仕様・Runbook・PR本文・DoDブロック・復旧/診断コマンドを**生成**（UIで提示）。  
- **あなた/Claude Code**：提示コマンドの**実行**、ファイルの**新規作成/コミット/PR**。  
- **PRは落ちない設計**：DoD Autofix（本文自動整形）＋ ci-alias-status（旧名Requiredへのsuccess付与）＋ Auto-merge。  
- **詰まり時**：  
  1) `gh pr checks <PR>` 2) `gh run view <run-id> --log` 3) `gh api …/protection -q '.required_status_checks.contexts'` を貼れば一発復旧案を返す。

## 4) 3分デモ（Feature-Confirmation Demo v1）
- `streamlit run ui/demo-ui/app.py` → メモ送信 → **δ/⃗d** 表示 → 「提案をPRにする」→ Auto-merge → `reports/*` と **STATE** 反映。  
- KPIダッシュボード：p50 / JSON error / ROUGE-L が実値で動作。  
- Chaos Audit：`vmp_chaos_event` マーカーと KPI を同画面で可視化。  
> AI APIは既定OFF。必要時のみON（NetworkPolicyやENVで管理）。

## 5) 直近の推奨タスク（優先順）
1. **Demo v1 定着**（Runbookどおり）  
2. **P3-3 latency-inject**（遅延注入で SLO 耐性の最小実証）  
3. **P3-5 監査の一体化**（PRテンプレへ PROV/ダッシュボード/証跡リンク差し込み）  
4. **Phase 4 先取り**（Argo CD 最小導入）

## 6) 診断チートシート（抜粋）
```bash
# PR/CI
gh pr checks <PR> --watch
gh run view <run-id> --log
gh api repos/<OWNER>/<REPO>/branches/main/protection -q '.required_status_checks.contexts'
# Knative
kubectl -n hyper-swarm get ksvc hello-ai -o yaml | sed -n '1,80p'
# Prometheus
kubectl -n monitoring port-forward svc/prometheus 9090:9090 &
curl -s 'http://localhost:9090/api/v1/query?query=histogram_quantile(0.5,sum by (le)(rate(prometheus_http_request_duration_seconds_bucket[5m])))'
```

**ポイント**：Specは純化→Runbook誘導、PRは落ちない自動化、証跡はreports、STATE＋タグで復元可。  
**次回は「Demo v1 起動」の一言から開始**。
