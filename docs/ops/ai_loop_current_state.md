# AIループ現状整理（LLMリレー / Codex / GKE コスト）

> repo=vpm-mini / branch=main  
> テーマ: 「啓のコピペなしで開発ループが回る状態」をどう実現するか。  
> その文脈での **現状認識 / 課題 / 当面の方針** をまとめる。

---

## 1. ゴールの再定義（目指す「グルグル状態」）

最終的に目指しているのは、次のような自走ループである：

1. 人間（啓）が `/ask` や高レベルな意図・制約を与える。
2. **LLMリレー** が、「何をいつやるか」を決めて **job 定義（例: job.json）** を書き出す。
3. **実行エージェント（将来的には VM Codex / ARC runner など）** が、その job を読み：
   - devbox / GKE / GitHub を操作して作業を実行。
4. 結果が：
   - `reports/**`
   - PR / Issue コメント
   などとして残り、必要なときだけ人間が最終承認や大きな方向転換を行う。

キモは：

- **啓のコピペや手動コマンドに依存せず、ループが「気づけば進んでいる」状態** を作ること。
- そのループが、SSOT（STATE / docs / reports）と一貫した形で進化すること。

---

## 2. 現状の各コンポーネントの立ち位置

### 2.1 ChatGPT（プロジェクト常駐）

- 参謀役。C / G / δ の整理、設計、文章化を担当。
- 直接の実行権限は持たず、**Mac Codex / VM Codex / LLMリレー に渡す brief** を生成する。

### 2.2 LLMリレー（GitHub Actions 内）

- `/ask` コメントに応じて、`gpt-5` を呼び出し：
  - 指示書（brief）
  - コマンド例
  - レポート案
  をテキストで出力する「単発バッチ係」。
- 現状は：
  - 「人間が投げた /ask に応える」役割に留まっている。
  - **実行エージェントへ自動で job を渡す仕組みは存在しない。**

### 2.3 VM Codex（devbox オペレーター）

- devbox-codex VM にログインして手を動かす実行係。
- devbox 内では `git`, `gh`, `kubectl`, 各種スクリプト等ほぼ何でも実行可能。
- 現状は：
  - 啓が渡した brief / コマンドをもとに動く「半自動オペレーター」。
  - LLMリレー とは「人力コピペ」以外のつながりはない。

### 2.4 Mac Codex（ローカル Mac オペレーター）

- ローカル Mac 上の開発作業を代行できる「最強のジョーカー」。
- フル権限・フルツールが揃っており、**開発作業の実行力は現時点で最強**。
- 一方で：
  - スリープや電源OFF、持ち歩き等、人間の生活リズムに依存。
  - 「24/7 自動ループの本番基盤」にはしにくい。

### 2.5 GKE クラスタ

- 将来の VPM / Swarm 運用に向けた **開発対象物**。
- 現状：
  - VPM の自走ループ（LLMリレー ↔ 実行エージェント）には組み込まれていない。
  - 毎日 ~800円程度の固定費が発生しており、**ほぼ「現状維持コスト」になっている。**

---

## 3. 現状の問題点

1. **GKE コストが「建設的なコスト」になっていない**

   - ほとんど手が入っていないにもかかわらず、  
     毎日 ~800円 のコストが発生している。
   - GKE 上で継続的に実行・検証される job がないため、  
     「払っている間に何かが良くなっている」とは言い難い状態。

2. **LLMリレー ↔ 実行エージェント が自走していない**

   - LLMリレー は `/ask` に応じてテキストを吐くだけ。
   - VM Codex は、啓が brief を渡したときだけ devbox 上で動く。
   - 二者の間に、**機械可読な「ジョブ受け渡し口」が存在しない。**

3. **啓のコピペと手動判断がボトルネック**

   - LLMリレー の出力 → 啓が読み → Cloud Shell / Codex に貼る  
     という「人間ハブ」が残っており、自走ループ化を阻害している。
   - このままでは、「啓が忙しい日はループが止まる」構造から抜け出せない。

---

## 4. 当面の方針（短期〜中期）

### 4.1 誰をどう強くするか

- **短期（開発フェーズで一番実行力を発揮してほしい人）：**
  - → **Mac Codex（ローカル Mac）**
  - 理由：
    - フル権限・フルツールが揃っており、新しい仕組みを最速で実装・検証できる。

- **中期（自走ループの本番実行基盤として強くしたい人）：**
  - → **VM Codex（devbox 実行エージェント）**
  - 理由：
    - 人間の生活リズムから切り離された環境であり、24/7 運用に向いている。
    - 将来 GKE / 社内インフラ への展開を見据えた「非属人基盤」にしやすい。

- **将来的にプランナー / スケジューラとして育てたい人：**
  - → **LLMリレー（GitHub Actions 内）**
  - 理想像：
    - `jobs/**.json` などに「やるべきジョブ」を書き出し、
    - 実行エージェントに渡す「心臓部」として機能する。

### 4.2 技術的に足りていないピース（明文化）

現時点で、「啓のコピペなしグルグル」に向けて **はっきり足りないものは2つ**：

1. **機械可読な「ジョブの受け渡し口」**

   - 例: `jobs/queue/2025-11-XX-001.json`
   - ミニマルなフォーマット例：
     ```json
     {
       "id": "2025-11-XX-001",
       "kind": "run_shell",
       "workdir": "/workspace/vpm-mini",
       "script": [
         "git pull --ff-only",
         "pytest tests/smoke/test_foo.py"
       ],
       "dod": "exit_code == 0",
       "report_path": "reports/jobs/2025-11-XX-001.out"
     }
     ```

2. **その job を見て動く「実行エージェントの常駐プロセス」**

   - 場所：まずは devbox（将来 GKE / ARC runner に拡張）。
   - 役割：
     - `jobs/queue/*.json` を監視 or ポーリング。
     - 新しい job を 1 件ずつ拾って実行。
     - 結果を `report_path` や GitHub コメントとして書き戻す。
   - 最初はシンプルな Python / shell スクリプトでもよい。

---

## 5. GKE コストに対する方針

- **現状認識**
  - GKE は「いつか活きる開発対象物」だが、
  - いまは VPM 自走ループの外側にあり、  
    約 800円/日 のコストが主に「現状維持費」になっている。

- **目指す状態**
  - GKE が自走ループの一部になり：
    - 毎日なにか小さな job（例: `kubectl get ksvc hello` の READY 確認）が動く。
    - その結果が `reports/**` やメトリクスとして残る。
  - この状態になった時点で、同じ 800円/日 が **「建設的なコスト」** と言える。

- **当面のステップ案**
  1. まずは devbox 上で、「job.json + runner」による **最小ループ** を完成させる。  
     （Mac Codex ＋ ChatGPT で実装）
  2. その仕組みを GKE 側に拡張し：
     - 例えば「毎朝 1 回、GKE 上の hello KService の READY をチェックしてレポートする」  
       といった job から着手する。

---

## 6. まとめ

- **現状**
  - GKE コストはほぼ現状維持費になっている。
  - LLMリレー ↔ VM Codex の間に、機械可読な job インターフェースがなく、  
    啓のコピペがボトルネックになっている。

- **課題**
  - job.json 的な「ジョブ受け渡し口」と、
  - それを処理する devbox / GKE runner が欠けている。

- **方向性**
  1. **短期**：  
     Mac Codex を開発用の最強ジョーカーとして使い、  
     「job.json + devbox runner」の最小ループを実装する。
  2. **中期**：  
     LLMリレー に job.json を発行させ、  
     VM Codex / runner を本番実行エージェントとして育てる。
  3. **その先**：  
     GKE をループの一部に組み込み、  
     コストを「現状維持費」から「自走ループの燃料」に変えていく。

本ドキュメントは、上記の **現状 / 課題 / 方針** を SSOT として明文化し、  
将来の設計・実装・振り返りの基準とすることを目的とする。
