
u_contract 永続化ポリシー（M-phase v0 ドラフト）
1. 背景

ask-entry からの /ask 実行時に、LLM への入力と出力の「契約」を JSON として残す仕組みがある。

その一部として、ask: persist u_contract (...) というタイトルの PR が自動生成され、reports/ask/ask_*.json のようなファイルを main に永続化しようとしている。

現状、これらの PR が多数 Open のまま残っており、どこまでを SSOT として扱うかの方針が決まっていない。

関連 Issue:

Task-M2: u_contract 永続化ポリシー & PR 整理 (#738)

Ask: PR Groomer (M-phase) (#733) — u_contract 系 PR 群は category: needs-triage として一旦「要方針決定」に寄せた。

2. u_contract の役割（整理）

u_contract は、LLM に投げる「入力」「期待する出力」「前提条件」などをまとめた 契約オブジェクト。

主な目的は次の通り：

/ask の挙動を後から再現できるようにする（再実行・デバッグ用）。

「このタイミングで何を聞き、何を期待していたか」を Evidence として残す。

将来的には Guard / Swarm 側で「契約違反」を検知する材料になる。

したがって、

すべて の u_contract を無期限に main に残す必要はないが、

ある程度の範囲は 再現性と監査性のために残しておきたい。

3. 要件（M-phase 時点での整理）

M-phase で満たしたい要件を、いったん v0 として言語化する。

再現性

直近の /ask 実行については、「どんな契約で投げたか」を後から見返せるようにしたい。

少なくとも「問題になった / 重要な」run については、契約をたどれること。

ノイズ抑制

main ブランチ上で、意味のない JSON ファイルが無限に増えていく状態は避けたい。

PR 一覧も「契約 PR だらけ」にならないようにしたい。

整理しやすさ

将来 M-3 以降で、契約の集約やアーカイブを自動化できる余地を残しておく。

4. ポリシー v0（案）

※ 本セクションはドラフト。数値や閾値は今後調整する前提。

4.1 スコープ

対象とする PR:

タイトルが ask: persist u_contract ... で始まる PR。

中身として、reports/ask/ask_*.json 等の u_contract JSON ファイルのみ追加・更新しているもの。

4.2 SSOT として残す範囲（v0 方針）

SSOT としては 「契約の型」と「代表的なサンプル」 が重要であり、すべての個別 run を同じ重みで残す必要はない。

v0 では次のように考える：

「代表サンプル」として残すもの

特定のパイプ（例: ask-entry / PR-direct / Memory など）について、

代表的な 1〜数本の u_contract を SSOT として残す。

これらは docs/ からリンクするなどして「参照すべきサンプル」と位置づける。

「履歴」として残すもの

直近 N 日分、または直近 N 本分の u_contract は、reports/ask/ 配下に JSON として残してよい。

ただし、この範囲は今後 M-3 で「ローテーション（古いものをアーカイブへ移動）」する前提。

それ以外

それ以外の古い u_contract は、必要であれば別ブランチや外部ストレージにアーカイブする。

main からは削除 / ローテーションしてもよい。

（N の具体値やアーカイブ先は、M-2 後半〜M-3 で決定する。）

4.3 PR の扱い（v0）

ask: persist u_contract ... PR については、次のいずれかに分類する。

SSOT サンプルとして残す PR

「この契約は今後も参照したい」という run が含まれている場合。

対応する JSON を SSOT として残す前提で、PR を merge する。

通常履歴として残す PR

直近の run であり、N の範囲内の履歴として許容できる場合。

JSON を残したいなら merge、不要なら別手段で JSON をアーカイブしてから Close。

整理対象の PR

古い / 重複している / 代表サンプルとしても不要な場合。

PR 上に「どこにアーカイブしたか」をコメントしてから Close する。

M-2 の間は、上記の分類と判断を 人間＋PR グルーマー で行い、
将来的に M-3 で自動化（定期スイープ）を検討する。

5. 今後のステップ（M-2 → M-3）

M-2-α:

Open な u_contract 系 PR（#731, #723, #722, ...）を上記ポリシー v0 で分類する。

代表サンプル候補の PR を数本選び、merge or 別の SSOT ファイルに統合する。

M-2-β:

「直近 N 本を残す」など、暫定的な閾値を決めて、古い PR に対して Close or アーカイブを実施する。

M-3:

ask-entry のパイプラインを拡張し、

一定期間を過ぎた u_contract を自動でアーカイブ／削除する仕組みを検討する。

PR グルーマー（/ask pr_groomer_suggest）に u_contract 用のロジックを統合し、定期的な整理を自動化する。

6. このドキュメントの位置づけ

本ドキュメントは M-phase における u_contract 永続化ポリシーのドラフト。

最終的な閾値や具体的な運用フローは、Task-M2 (#738) の議論と実験結果に基づいて更新する。

重要な変更があれば、STATE/current_state.md 側にも要点を反映する。
