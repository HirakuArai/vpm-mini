# CD Reports Documentation

## Overview

Continuous Delivery (CD) pipeline execution data is automatically collected and aggregated for observability and analysis.

## Report Files

### 1. `reports/cd_runs.ndjson`

**Format:** Newline-delimited JSON (NDJSON)  
**Purpose:** Append-only log of all CD pipeline executions  
**Schema:** `schema/cd_run.schema.json`

Each line represents a single CD run with the following structure:

```json
{
  "runId": "17350536577",
  "runUrl": "https://github.com/HirakuArai/vpm-mini/actions/runs/17350536577",
  "sha": "9c4931e...",
  "timestamp": "2025-08-31T00:52:48Z",
  "namespace": "hyper-swarm",
  "ksvc": "hello",
  "canary": 10,
  "status": "success|freeze|failed",
  "clusters": {
    "A": {"duration_sec": 12, "result": "success"},
    "B": {"duration_sec": 13, "result": "success"}
  }
}
```

**Status Values:**
- `success`: Both clusters deployed successfully
- `freeze`: Deployment skipped due to freeze flag
- `failed`: One or more clusters failed

### 2. `reports/cd_summary.json`

**Format:** JSON  
**Purpose:** Aggregated statistics from last 100 runs  
**Generated by:** `scripts/cd_report_summary.py`

```json
{
  "updated_at": "2025-08-31T01:00:00Z",
  "total_runs": 42,
  "success_rate": 0.95,
  "freeze_rate": 0.03,
  "fail_rate": 0.02,
  "p50_duration_sec": {"A": 12, "B": 13},
  "p95_duration_sec": {"A": 25, "B": 27},
  "last_run": { /* most recent cd_run object */ }
}
```

**Metrics:**
- **success_rate**: Percentage of successful deployments
- **freeze_rate**: Percentage of frozen (skipped) deployments
- **fail_rate**: Percentage of failed deployments
- **p50_duration_sec**: Median deployment duration per cluster
- **p95_duration_sec**: 95th percentile deployment duration

## Viewing Reports

### Raw Data Access

1. **Via GitHub UI:**
   - Navigate to `reports/cd_runs.ndjson`
   - Click "Raw" button for plain text view
   - Download for local analysis

2. **Via CLI:**
   ```bash
   # View last 5 runs
   tail -n 5 reports/cd_runs.ndjson | jq .
   
   # View current summary
   cat reports/cd_summary.json | jq .
   ```

3. **Via API:**
   ```bash
   # Get raw NDJSON
   curl -H "Accept: application/vnd.github.v3.raw" \
     https://api.github.com/repos/HirakuArai/vpm-mini/contents/reports/cd_runs.ndjson
   ```

## Analysis Examples

### Success Rate Trend
```bash
# Calculate success rate from last 20 runs
tail -n 20 reports/cd_runs.ndjson | \
  jq -s 'map(select(.status == "success")) | length / 20'
```

### Average Duration
```bash
# Average duration for cluster A (successful runs)
tail -n 50 reports/cd_runs.ndjson | \
  jq -s 'map(select(.status == "success") | .clusters.A.duration_sec) | add/length'
```

### Failure Analysis
```bash
# Find failed runs with details
grep '"status":"failed"' reports/cd_runs.ndjson | jq .
```

## Integration Points

### Future Enhancements (P6-2b)

1. **Prometheus Pushgateway Integration:**
   - Push metrics after each run
   - Expose as Prometheus metrics

2. **Grafana Dashboard:**
   - Real-time success rate visualization
   - Duration percentile graphs
   - Failure rate alerts

3. **SLO Tracking:**
   - CD success rate target: 99%
   - P95 duration target: < 30s

## Schema Validation

Validate NDJSON entries against schema:

```bash
# Install ajv-cli if needed
npm install -g ajv-cli

# Validate all entries
cat reports/cd_runs.ndjson | while read line; do
  echo "$line" | ajv validate -s schema/cd_run.schema.json -d -
done
```

## Maintenance

- **Rotation:** NDJSON file auto-rotates after 10,000 lines (future enhancement)
- **Backup:** Reports are committed to git for permanent record

> CI tickle: ensure required checks run for PR #124
- **Cleanup:** Old entries beyond 90 days can be archived